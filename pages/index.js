import Head from 'next/head';
import styles from '../styles/Home.module.css';
import { useReactMediaRecorder } from 'react-media-recorder';
import React, { useState, useEffect, useMemo } from 'react';
import dynamic from 'next/dynamic';

export default function Home() {
  const Waveform = dynamic(() => import('../components/WaveForm'), {
    ssr: false,
  });
  const [audioBlobs, setAudioBlobs] = useState([]);
  const [masterAudio, setMasterAudio] = useState(null);
  const [isLoading, setIsLoading] = useState(false);

  const handleSaveAudio = async (data) => {
    const blob = await fetch(data).then((r) => r.blob());
    setAudioBlobs([...audioBlobs, blob]);
  };

  const { startRecording, stopRecording } = useReactMediaRecorder({
    audio: true,
    blobPropertyBag: {
      type: 'audio/wav',
    },
    onStop: handleSaveAudio,
  });

  const handlePreview = async () => {
    setIsLoading(true);

    const concatRecordings = () => {
      const blob = new Blob(audioBlobs);
      // const url = URL.createObjectURL(blob);
      // const audio = new Audio(url);
      // audio.play();
      setMasterAudio(blob);
    };
    concatRecordings();
    setIsLoading(false);
  };

  return (
    <div className={styles.container}>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main className={styles.main}>
        <h1 className={styles.title}>Audio editor Proof of Concept</h1>
        <div>
          <p className={styles.description}>
            Let&apos;s start recording audio:
          </p>
          <button onClick={startRecording}>Start Recording</button>
          <button onClick={stopRecording}>Stop Recording</button>
          <div>
            {audioBlobs.length >= 0 &&
              audioBlobs.map((audioFile, idx) => (
                <Waveform
                  key={`wave-${idx}`}
                  name={`wave-${idx}`}
                  blob={audioFile}
                />
              ))}
          </div>
          <div>
            <p className={styles.description}>All audio files merged:</p>
            <button onClick={handlePreview}>Listen preview</button>
          </div>
          <div>
            {masterAudio && <Waveform blob={masterAudio} name="master" />}
          </div>
        </div>
      </main>
    </div>
  );
}
